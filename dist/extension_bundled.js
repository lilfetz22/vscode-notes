var u=require("vscode"),$=require("compromise"),z=require("os"),k=require("path"),G=require("fs"),{Uri:L,Range:w,Position:x,DocumentLink:S,DocumentLinkProvider:Y,commands:C,languages:K,workspace:Z,window:ee}=u,D={Noun:"entity_name_type",Verb:"entity_name_function",Adjective:"entity_other_attribute_name",Adverb:"adverb_language",Value:"value_type"},Q=["entity_name_type","entity_name_function","entity_other_attribute_name","adverb_language","value_type"];exports.activate=async function(m){m.subscriptions.push(C.registerTextEditorCommand("notesnlh.cycleTaskForwardNew",O),C.registerTextEditorCommand("notesnlh.cycleTaskBackwardNew",B)),m.subscriptions.push(u.workspace.onDidChangeConfiguration(e=>{e.affectsConfiguration("notesnlh")&&u.workspace.textDocuments.forEach(n=>{n.languageId==="notesnlh"&&u.languages.triggerTokenSemanticTokensRefresh()})}));function j(e){return e.slice(0,1)=="~"?k.join(z.homedir(),e.slice(1,e.length)):e}function E(e,n){return e.replace(/\$(\d+)/g,(l,o)=>n[parseInt(o,10)])}let v=/("([^"]+?\.notesnlh)"|[^\s]+?\.notesnlh)/g,A=/\[\/([^\/]+)\/\s*->\s*(https?:\/\/[^\]]+)\]/g,N={provideDocumentLinks:async function(e,n){let l;e.uri.scheme==="file"?l=k.dirname(e.uri.fsPath):l=null;let o=e.getText(),s,i=[];if(linkPatterns=u.workspace.getConfiguration("notesnlh").linkPatterns,linkPatterns)for(let[t,r]of Object.entries(linkPatterns))i.push({regexp:t,link:r});for(;s=A.exec(o);)i.push({regexp:s[1],link:s[2]});let f=[];for(;s=v.exec(o);){let t=e.positionAt(v.lastIndex),r=t.translate({characterDelta:-s[1].length}),g=new w(r,t),a=j(s[2]?s[2]:s[1]),c;if(k.isAbsolute(a))c=a;else if(l)c=k.resolve(l,a);else continue;let p=L.file(c),_=new S(g,p);f.push(_)}for(pattern of i){let t=new RegExp(pattern.regexp,"g");for(;s=t.exec(o);){let r=e.positionAt(t.lastIndex),g=r.translate({characterDelta:-s[0].length}),a=new w(g,r),c=L.parse(E(pattern.link,s)),p=new S(a,c);f.push(p)}}return f}};m.subscriptions.push(K.registerDocumentLinkProvider({scheme:"file",language:"notesnlh"},N));function I(e){let n={};for(let l in e)n[e[l]]=l;return n}let y={"[ ]":"[\u221A]","[\u221A]":"[!]","[!]":"[x]","[x]":"[ ]"};function R(e){let n=y[e];return n||e}function q(e){let n=I(y)[e];return n||e}function O(e){P(e,R)}function B(e){P(e,q)}function P(e,n){e.edit(l=>{e.selections.forEach(o=>{let s=o.start.line;for(;s<=o.end.line;){let i=e.document.lineAt(s),f=i.text.match(/^\s*(\[.?\])/);if(f){let t=f[1],r=i.text.indexOf(t),g=new w(new x(s,r),new x(s,r+3)),a=n(t);l.replace(g,a)}else{let t=o.active.character,r=i.text.match(/[^\s]/);r&&(t=i.text.indexOf(r[0])),l.insert(new x(s,t),"[ ] ")}s++}})})}function W(){let e=k.join(__dirname,"..","syntaxes","notesnlh.tmLanguage.json"),n=G.readFileSync(e,"utf8"),o=JSON.parse(n).patterns.filter(s=>s.begin&&s.begin.includes("\\[")&&s.begin.includes("\\]")).map(s=>{let i=s.begin.match(/\\\[(.*?)\\\]/);return i?i[1].split("|"):[]}).flat();return new Set(o)}function b(e,n,l){for(let o of l)if(e>o.start.line&&e<o.end.line||e===o.start.line&&n>=o.start.character||e===o.end.line&&n<=o.end.character)return!0;return!1}function F(e,n){switch(e.toLowerCase()){case"noun":return n.get("highlightNouns");case"verb":return n.get("highlightVerbs");case"adjective":return n.get("highlightAdjectives");case"adverb":return n.get("highlightAdverbs");case"value":return n.get("highlightNumbers");default:return!1}}let M={provideDocumentSemanticTokens(e){let n=e.getText(),l=W(),o=n.split(`
`),s=[];for(let t=0;t<o.length;t++){let r=o[t].trim();(r.startsWith("//")||r.startsWith("#")||r.startsWith("[!]")||r.startsWith("[\u221A]"))&&s.push({start:new u.Position(t,0),end:new u.Position(t,o[t].length)});let g=r.match(/^\[([^\]]+)\]/);if(g&&l.has(g[1])){let a=t;for(;t<o.length&&!o[t].includes("[end]")&&!o[t].includes("[/");)t++;s.push({start:new u.Position(a,0),end:new u.Position(t,o[t].length)})}}try{let r=$(n).json(),g=new u.SemanticTokensBuilder(T),a=0,c=0,p=u.workspace.getConfiguration("notesnlh");for(let H of r)for(let h of H.terms){if(!h||typeof h!="object"){console.log("Invalid term:",h,"type of term:",typeof h);continue}var i=h.tags[0];i.toLowerCase().includes("noun")&&(i="Noun");let U=h.pre;for(let d of U)d===`
`?(a++,c=0):c++;if(!b(a,c,s)&&D[i]&&F(i,p)){let d=new u.Range(new u.Position(a,c),new u.Position(a,c+h.text.length));var f=!1;g.push(d,D[i])}for(let d of h.text)d===`
`?(a++,c=0):c++;let J=h.post;for(let d of J)d===`
`?(a++,c=0):c++;b(a,c,s)&&(c=0,f=!0)}return g.build()}catch(t){return console.error("Error in provideDocumentSemanticTokens:",t),null}}},V={language:"notesnlh",scheme:"file"},T=new u.SemanticTokensLegend(Q);m.subscriptions.push(u.languages.registerDocumentSemanticTokensProvider(V,M,T))};
